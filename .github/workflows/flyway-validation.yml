name: âœ… Flyway Migration Check

on:
  pull_request:
    paths:
      - 'src/main/resources/db/migration/**'

jobs:
  check-migrations:
    name: ğŸ” Check Migration Files
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Get code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'oracle'
          
      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“‹ Check migration files
        run: |
          echo "ğŸš€ Checking migration files..."
          ./scripts/validate-migration-files.sh

      - name: ğŸ¬ Setup MySQL
        run: |
          docker run --name mysql-test \
            -e MYSQL_ROOT_PASSWORD=1234 \
            -e MYSQL_DATABASE=gamchi \
            -p 3306:3306 \
            -d mysql:8.0
          
          # Wait for MySQL to be ready
          echo "â³ Waiting for MySQL to start..."
          until docker exec mysql-test mysqladmin ping -h"localhost" --silent; do
            sleep 2
          done
          echo "âœ… MySQL is ready!"
          
      - name: ğŸ§ª Validate SQL syntax
        env:
          DB_HOST: localhost
          DB_USERNAME: root
          DB_PASSWORD: 1234
        run: |
          echo "ğŸ§ª Testing SQL syntax with Flyway..."
          ./gradlew flywayValidate